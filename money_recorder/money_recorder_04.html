<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Android Studioでお小遣い帳を作るチュートリアルです。今回はViewModelを導入していきます。">

        <title>Android Studioでお小遣い帳を作る#04 - ViewModel編</title>

        <link rel="stylesheet" href="../css/style.css">

        <!-- Google font -->
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&family=Noto+Sans+Mono:wght@100..900&display=swap" rel="stylesheet">
    </head>
    <body>
        <div class="container">
            <header id="header">
                sakura ブログ
            </header>

            <div class="content">
                <main id="main">
                    <!-- タイトル -->
                    <section class="title">
                        <h1>
                            Android Studioでお小遣い帳を作る #04 <br>
                            ViewModel作成編
                        </h1>
                        <p>2025/11/17 sakura</p>
                    </section>

                    <!-- 前書き -->
                    <section class="">
                        <h2>前書き</h2>
                        <p>
                            前回まででホーム画面、記録画面を作り、画面遷移ができるようにしました。しかし、まだ画面操作ができません。<br>
                            なので今回は、ViewModelを導入し、入力を保存して画面操作ができるようにしていきましょう。
                        </p>
                    </section>

                    <!-- 目次 -->
                    <section id="index">
                        <h2>目次</h2>
                        <nav>
                            <ul>
                                <li><a href="#gradle">gradleファイルに付け足し</a></li>
                                <li><a href="#home_screen">ホーム画面のViewModel作成</a></li>
                                <li><a href="#view_model_provider">ViewModelProviderの作成</a></li>
                                <li><a href="#input_screen">記録画面のViewModel作成</a></li>
                                <li><a href="#test">実機テストとまとめ</a></li>
                            </ul>
                        </nav>
                    </section>

                    <section id="gradle">
                        <h2>gradleファイルに付け足し</h2>
                        <p>
                            ViewModelを導入するのにもgradleファイルのdependenciesに付け足さなければいけません。以下のコードをまた付け足してください。
                        </p>
                        <div class="code_line_box" translate="no">
                            <span class="title">build.gradle.kts (Module :app)</span><br>
                            <pre>dependencies {</pre>
                            <pre>    省略</pre>
                            <pre><br></pre>
                            <pre>    //ViewModel</pre>
                            <pre>    implementation("androidx.lifecycle:lifecycle-viewmodel-compose:2.9.4")</pre>
                            <pre>    </pre>
                            <pre>}</pre>
                        </div>
                        <p>
                            そしてまた同期させてください。
                        </p>
                    </section>

                    <section id="home_screen">
                        <h2>HomeScreenのViewModelファイルの作成</h2>
                        <p>
                            少し面倒ですが、一つの画面ファイルに対し、一つのViewModelのファイルを作らなければいけません。
                            まずは<span class="code">HomeScreen.kt</span>の分から作っていきましょう。
                            <span class="code">screen</span>ディレクトリの下に次のように<span class="code">HomeScreenViewModel.kt</span>を作ってください。
                        </p>
                        <div class="image_center_small">
                            <img src="./img/04_00.png" alt="">
                        </div>
                        <p>
                            classを選択してファイルを作成したのでclassが新しく定義されている状態だと思います。
                            先ほどViewModelをインポートしましたが、その中に入っている<span class="code">ViewModel()</span>クラスを継承させたいと思います。
                            次のようにコードを少し書き加えてください。
                        </p>
                        <div class="code_line_box" translate="no">
                            <span class="title">HomeScreenViewModel.kt</span><br>
                            <pre>import androidx.lifecycle.ViewModel</pre>
                            <pre><br></pre>
                            <pre>class HomeScreenViewModel(</pre>
                            <pre>    </pre>
                            <pre>) : ViewModel() {</pre>
                            <pre>    </pre>
                            <pre>}</pre>
                        </div>
                        <p>
                            これはC#の継承と似ていますね。
                        </p>
                        <p>
                            中身については、ホーム画面では現在どのナビゲーションバーが選択されているかが保存したいのでその部分を書いていきましょう。
                        </p>
                        <div class="code_line_box" translate="no">
                            <span class="title">HomeScreenViewModel.kt</span><br>
                            <pre>class HomeScreenViewModel(</pre>
                            <pre><br></pre>
                            <pre>) : ViewModel() {</pre>
                            <pre>    //NavigationBar関連 -----------------------------------------------------------------------------</pre>
                            <pre>    var selectedNavigationItem by mutableIntStateOf(0) //可変変数の定義</pre>
                            <pre>        private set                                           //ViewModelでのみ変更可能</pre>
                            <pre><br></pre>
                            <pre>    fun updateSelectedNavigationItem(i: Int) {                //変更する際の関数</pre>
                            <pre>        selectedNavigationItem = i</pre>
                            <pre>    }</pre>
                            <pre>}</pre>
                        </div>
                        <p>
                            これは<span class="code">selectedNavigationItem</span>をViewModel内で定義し、ViewModelでのみ変更可能、変更する際は<span class="code">updateSelectedNavigationItem(int)</span>を呼び出す必要がある。ということです。
                            少々回りくどいと思うと思いますが、Android Studioにおいて大切であるそうです。
                        </p>
                        <p>
                            とりあえずホーム画面のViewModelが今ある機能まではできました。今度はこのViewModelを<span class="code">HomeScreen.kt</span>に渡すための<span class="code">ViewModelProvider</span>を作っていきましょう。
                        </p>
                    </section>

                    <section id="view_model_provider">
                        <h2>ViewModelProviderの作成</h2>
                        <p>
                            <span class="code">com.___.money_recorder</span></p>ディレクトリの下に次のように<span class="code">AppViewModelProvider.kt</span>を作成してください。今回はobjectで作ります。
                        </p>
                        <div class="image_center_small">
                            <img src="./img/04_01.png" alt="">
                        </div>
                        <p>
                            そして、次のようなコードを書いてください。
                        </p>
                        <div class="code_line_box" translate="no">
                            <span class="title">AppViewModelProvider.kt</span><br>
                            <pre>import androidx.lifecycle.ViewModelProvider</pre>
                            <pre>import androidx.lifecycle.viewmodel.initializer</pre>
                            <pre>import androidx.lifecycle.viewmodel.viewModelFactory</pre>
                            <pre>import com.sakura.money_recorder.ui.screen.HomeScreenViewModel</pre>
                            <pre><br></pre>
                            <pre>object AppViewModelProvider {</pre>
                            <pre>    val Factory: ViewModelProvider.Factory = viewModelFactory {</pre>
                            <pre>        initializer {</pre>
                            <pre>            HomeScreenViewModel()</pre>
                            <pre>        }</pre>
                            <pre>    }</pre>
                            <pre>}</pre>
                        </div>
                        <p>
                            この<span class="code">Factory</span>というところにいろいろ書いてありますが、他のViewModelを追加したときにまたここに追加して言います。
                            現時点ではこれで完成です。
                            これのobjectについては、私もよくわからないのですが、シングルトン的なものかなと思っています。
                        </p>
                        <p>
                            では、これを<span class="code">HomeScreen.kt</span>内で使っていきましょう。以下のようにコードを付け足してください。
                        </p>
                        <div class="code_line_box" translate="no">
                            <span class="title">HomeScreen.kt</span><br>
                            <pre>@Composable</pre>
                            <pre>fun HomeScreen(</pre>
                            <pre><span class="add">    viewModel: HomeScreenViewModel = viewModel(factory = AppViewModelProvider.Factory), //追加</span></pre>
                            <pre>    onAddRecordButtonClicked: () -> Unit,</pre>
                            <pre>) {</pre>
                            <pre>    HomeScreenBody(</pre>
                            <pre><span class="add">        selectedNavIndex = viewModel.selectedNavigationItem,</span></pre>
                            <pre><span class="add">        onNavigationItemSelected = { viewModel.updateSelectedNavigationItem(it) },</span></pre>
                            <pre><br></pre>
                            <pre>        onAddRecordButtonClicked = onAddRecordButtonClicked</pre>
                            <pre>    )</pre>
                            <pre>}</pre>
                            <pre><br></pre>
                            <pre>@Composable</pre>
                            <pre>private fun HomeScreenBody(</pre>
                            <pre>    selectedNavIndex: Int = 0,</pre>
                            <pre><span class="add">    onNavigationItemSelected: (Int) -> Unit = {},</span></pre>
                            <pre>    onAddRecordButtonClicked: () -> Unit = {},</pre>
                            <pre>) {</pre>
                            <pre>    Scaffold(</pre>
                            <pre>        bottomBar = {</pre>
                            <pre><br></pre>
                            <pre>            NavigationBar {</pre>
                            <pre>                items.forEachIndexed { index, itemName -></pre>
                            <pre>                    NavigationBarItem(</pre>
                            <pre>                        icon = {</pre>
                            <pre>                            Icon(</pre>
                            <pre>                                imageVector = if (index == selectedNavIndex) selectedIcons[index] else icons[index],</pre>
                            <pre>                                contentDescription = null</pre>
                            <pre>                            )</pre>
                            <pre>                        },</pre>
                            <pre>                        label = { Text(text = itemName) },</pre>
                            <pre>                        selected = index == selectedNavIndex,</pre>
                            <pre><span class="add">                        onClick = { onNavigationItemSelected(index) }</span></pre>
                            <pre>                    )</pre>
                            <pre>                }</pre>
                            <pre>            }</pre>
                            <pre><br></pre>
                            <pre>        },</pre>
                            <pre>    )</pre>
                            <pre>}</pre>
                        </div>
                        <p>
                            まず、<span class="code">HomeScreen()</span>の引数部分で<span class="code">factory</span>の宣言をします。
                            こうすることでViewModelを受け取ることができます。<br>
                            そして、<span class="code">body()</span>のほうで<span class="code">Int</span>を引数とする関数<span class="code">onNavigationItemSelected()</span>を定義し、<span class="code">onClick()</span>で<span class="code">forEachIndexed</span>の引数の<span class="code">index</span>をその関数で引き渡すというコードも書いています。<br>
                            ここら辺のKotlinの書き方は私は初めてで慣れてきたらとても分かりやすいなと思ってます。
                        </p>
                        <p>
                            では、今度は<span class="code">InputMoneyRecordScreen</span>のほうのViewModelを作っていきましょう。
                        </p>
                    </section>

                    <section id="input_screen">
                        <h2>記録画面のViewModel作成</h2>
                        <p>
                            <span class="code">screen</span>ディレクトリの下に次のように新しいclassファイルを作成してください。
                        </p>
                        <div class="image_center_small">
                            <img src="./img/04_02.png" alt="">
                        </div>
                        <p>
                            そして以下のコードを書いてください。
                        </p>
                        <div class="code_line_box" translate="no">
                            <span class="title">InputMoneyRecordScreenViewModel.kt</span><br>
                            <pre>import androidx.compose.runtime.getValue</pre>
                            <pre>import androidx.compose.runtime.mutableStateOf</pre>
                            <pre>import androidx.compose.runtime.setValue</pre>
                            <pre>import androidx.lifecycle.ViewModel</pre>
                            <pre>import com.sakura.money_recorder.data.MoneyRecordUiState</pre>
                            <pre>import com.sakura.money_recorder.getNowMillis</pre>
                            <pre><br></pre>
                            <pre>class InputMoneyRecordScreenViewModel(</pre>
                            <pre>) : ViewModel() {</pre>
                            <pre>    var moneyRecordUiState by mutableStateOf(MoneyRecordUiState()) //可変変数の定義</pre>
                            <pre>        private set</pre>
                            <pre><br></pre>
                            <pre>    init { //初期化</pre>
                            <pre>        moneyRecordUiState = MoneyRecordUiState(time = getNowMillis()) //時刻を現在時刻に設定</pre>
                            <pre>    }</pre>
                            <pre><br></pre>
                            <pre>    fun updateMoneyRecordUiState(newMoneyRecordUiState: MoneyRecordUiState) { //変更する際の関数</pre>
                            <pre>        moneyRecordUiState = newMoneyRecordUiState</pre>
                            <pre>    }</pre>
                            <pre>}</pre>
                        </div>
                        <p>
                            そして、<span class="code">AppViewModelProvider.kt</span>に次のコードを追加してください。
                        </p>
                        <div class="code_line_box" translate="no">
                            <span class="title">AppViewModelProvider.kt</span><br>
                            <pre>object AppViewModelProvider {</pre>
                            <pre>    val Factory: ViewModelProvider.Factory = viewModelFactory {</pre>
                            <pre>        initializer {</pre>
                            <pre>            HomeScreenViewModel()</pre>
                            <pre>        }</pre>
                            <pre><span class="add">        initializer {</span></pre>
                            <pre><span class="add">            InputMoneyRecordScreenViewModel()</span></pre>
                            <pre><span class="add">        }</span></pre>
                            <pre>    }</pre>
                            <pre>}</pre>
                        </div>
                        <p>
                            そして、<span class="code">InputMoneyRecordScreen.kt</span>に引き渡すコードを書いていきましょう。
                        </p>
                        <div class="code_line_box" translate="no">
                            <span class="title">InputMoneyRecordScreen.kt</span><br>
                            <pre>@Composable</pre>
                            <pre>fun InputMoneyRecordScreen(</pre>
                            <pre><span class="add">    viewModel: InputMoneyRecordScreenViewModel = viewModel(factory = AppViewModelProvider.Factory),</span></pre>
                            <pre>    onBackButtonClicked: () -> Unit,</pre>
                            <pre><br></pre>
                            <pre>    ) {</pre>
                            <pre>    InputMoneyRecordScreenBody(</pre>
                            <pre><span class="add">        uiState = viewModel.moneyRecordUiState,</span></pre>
                            <pre><span class="add">        onUiStateChanged = viewModel::updateMoneyRecordUiState,</span></pre>
                            <pre>        </pre>
                            <pre>        onBackButtonClicked = onBackButtonClicked</pre>
                            <pre>    )</pre>
                            <pre>}</pre>
                        </div>
                        <p>
                            <span class="code">InputMoneyRecordScreenBody()</span>のほうで変更のアップデートの関数などをもう実装していたので、この三行の変更でもう完成です。<br>
                            今回は関数の引き渡しに<span class="code">viewModel::updateMoneyRecordUiState</span>と書きました。
                            これは引数を指定する関数の引き渡しに<span class="code">{viewModel.updateMoneyRecordUiState(uiState)}</span>と書くのとおんなじです。
                        </p>
                        <p>
                            では実機で確認してみましょう。
                        </p>
                    </section>

                    <section id="test">
                        <h2>実機テストとまとめ</h2>
                        <div class="image_center_handy_flex">
                            <img src="./img/04_03.png" alt="">
                            <img src="./img/04_04.png" alt="">
                        </div>
                        <p>
                            このようにホーム画面では残高や履歴も観れるようになっていて、記録画面ではテキストフィールドの入力、プラマイの変更、日付の選択、カテゴリの選択、メモの入力、記入例も正しく表示されていて、記録が正しく入力されている場合に記録ボタンも推せるようになっています。<br>
                            次回は、実際に記録ができるように、Roomの導入を進めていきましょう。
                        </p>
                    </section>
                </main>

                <aside id="side_bar">
                    <nav>
                        <ul>
                            <li><a href="../index.html">index.html</a></li>
                        </ul>
                    </nav>
                    <p>お小遣い帳を作る</p>
                    <nav>
                        <ul>
                            <li><a href="money_recorder_01.html">#01 プロジェクト作成</a></li>
                            <li><a href="money_recorder_02.html">#02 ホーム画面作成編</a></li>
                            <li><a href="money_recorder_03.html">#03 記録画面と画面遷移</a></li>
                            <li>#04 今回</li>
                            <li><a href="money_recorder_05.html">#05 Room導入編</a></li>
                        </ul>
                    </nav>
                    <div class="sticky">
                        <p><a href="#index">今回の目次</a></p>
                        <nav>
                            <ul>
                                <li><a href="#gradle">gradleファイルに付け足し</a></li>
                                <li><a href="#home_screen">ホーム画面のViewModel作成</a></li>
                                <li><a href="#view_model_provider">ViewModelProviderの作成</a></li>
                                <li><a href="#input_screen">記録画面のViewModel作成</a></li>
                                <li><a href="#test">実機テスト</a></li>
                            </ul>
                        </nav>
                    </div>
                </aside>
            </div>

            <footer>
                <p></p>
            </footer>
        </div>
    </body>
</html>